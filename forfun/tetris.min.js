var Tetris=function(){var f,g,k,l,m,n,p,r,s,t,u,v,w,x,y,z,A,B,C,b=20,c=14,d=24,e=0,h=0,i=1,j=0,o=!0,q=[];for(r=0;b>r;r++)for(q[r]=[],s=0;c>s;s++)q[r][s]=e;return t=["#fff","#f00","#0f0","#00f","#c60","#f0f","#0ff","#609"],u=[[{x:c/2-1,y:0,color:1},{x:c/2,y:0,color:1},{x:c/2,y:1,color:1},{x:c/2+1,y:1,color:1}],[{x:c/2+1,y:0,color:2},{x:c/2,y:0,color:2},{x:c/2,y:1,color:2},{x:c/2-1,y:1,color:2}],[{x:c/2-1,y:0,color:3},{x:c/2,y:0,color:3},{x:c/2-1,y:1,color:3},{x:c/2,y:1,color:3}],[{x:c/2-1,y:0,color:4},{x:c/2-1,y:1,color:4},{x:c/2-1,y:2,color:4},{x:c/2,y:2,color:4}],[{x:c/2,y:0,color:5},{x:c/2,y:1,color:5},{x:c/2,y:2,color:5},{x:c/2-1,y:2,color:5}],[{x:c/2,y:0,color:6},{x:c/2,y:1,color:6},{x:c/2,y:2,color:6},{x:c/2,y:3,color:6}],[{x:c/2,y:0,color:7},{x:c/2-1,y:1,color:7},{x:c/2,y:1,color:7},{x:c/2+1,y:1,color:7}]],v=function(){var a=Math.floor(Math.random()*u.length);p=[{x:u[a][0].x,y:u[a][0].y,color:u[a][0].color},{x:u[a][1].x,y:u[a][1].y,color:u[a][1].color},{x:u[a][2].x,y:u[a][2].y,color:u[a][2].color},{x:u[a][3].x,y:u[a][3].y,color:u[a][3].color}]},w=function(){var c,f,a=!0;for(c=0;c<p.length;c++){if(p[c].y>=b-1){a=!1;break}if(q[p[c].y+1][p[c].x]!=e){a=!1;break}}if(a){for(c=0;c<p.length;c++)f=p[c],g.fillStyle="white",g.fillRect(f.x*d+1,f.y*d+1,d-2,d-2);for(c=0;c<p.length;c++)f=p[c],f.y++;for(c=0;c<p.length;c++)f=p[c],g.fillStyle=t[f.color],g.fillRect(f.x*d+1,f.y*d+1,d-2,d-2)}else{for(c=0;c<p.length;c++){if(f=p[c],f.y<2)return localStorage.removeItem("curScore"),localStorage.removeItem("tetris_status"),localStorage.removeItem("curSpeed"),confirm("您已经输了！是否参数排名？")&&(j=localStorage.getItem("maxScore"),j=null==j?0:j,h>=j&&localStorage.setItem("maxScore",h)),o=!1,clearInterval(n),void 0;q[f.y][f.x]=f.color}C(),localStorage.setItem("tetris_status",JSON.stringify(q)),v()}},x=function(a,e,h,i){var j;for(f=document.createElement("canvas"),f.width=e*h,f.height=a*i,f.style.border="1px solid black",g=f.getContext("2d"),g.beginPath(),j=1;b>j;j++)g.moveTo(0,j*d),g.lineTo(c*d,j*d);for(j=1;c+1>j;j++)g.moveTo(j*d,0),g.lineTo(j*d,b*d);g.closePath(),g.strokeStyle="#aaa",g.lineWidth=.3,g.stroke()},y=function(){var a,f;for(a=0;b>a;a++)for(f=0;c>f;f++)q[a][f]!=e?(g.fillStyle=t[q[a][f]],g.fillRect(f*d+1,a*d+1,d-2,d-2)):(g.fillStyle="white",g.fillRect(f*d+1,a*d+1,d-2,d-2))},z=function(){var b,c,a=!0;for(b=0;b<p.length;b++){if(p[b].x<=0){a=!1;break}if(q[p[b].y][p[b].x-1]!=e){a=!1;break}}if(a){for(b=0;b<p.length;b++)c=p[b],g.fillStyle="white",g.fillRect(c.x*d+1,c.y*d+1,d-2,d-2);for(b=0;b<p.length;b++)c=p[b],c.x--;for(b=0;b<p.length;b++)c=p[b],g.fillStyle=t[c.color],g.fillRect(c.x*d+1,c.y*d+1,d-2,d-2)}},A=function(){var b,f,a=!0;for(b=0;b<p.length;b++){if(p[b].x>=c-1){a=!1;break}if(q[p[b].y][p[b].x+1]!=e){a=!1;break}}if(a){for(b=0;b<p.length;b++)f=p[b],g.fillStyle="white",g.fillRect(f.x*d+1,f.y*d+1,d-2,d-2);for(b=0;b<p.length;b++)f=p[b],f.x++;for(b=0;b<p.length;b++)f=p[b],g.fillStyle=t[f.color],g.fillRect(f.x*d+1,f.y*d+1,d-2,d-2)}},B=function(){var b,f,h,i,j,k,a=!0;for(b=0;b<p.length;b++)if(f=p[b].x,h=p[b].y,2!=b){if(i=p[2].x+h-p[2].y,j=p[2].y+p[2].x-f,q[j][i+1]!=e){a=!1;break}if(0>i||q[j-1][i]!=e){A(),i=p[2].x+h-p[2].y,j=p[2].y+p[2].x-f;break}if(0>i||q[j-1][i]!=e){A();break}if(i>=c-1||q[j][i+1]!=e){z(),i=p[2].x+h-p[2].y,j=p[2].y+p[2].x-f;break}if(i>=c-1||q[j][i+1]!=e){z();break}}if(a){for(b=0;b<p.length;b++)k=p[b],g.fillStyle="white",g.fillRect(k.x*d+1,k.y*d+1,d-2,d-2);for(b=0;b<p.length;b++)f=p[b].x,h=p[b].y,2!=b&&(p[b].x=p[2].x+h-p[2].y,p[b].y=p[2].y+p[2].x-f);for(b=0;b<p.length;b++)k=p[b],g.fillStyle=t[k.color],g.fillRect(k.x*d+1,k.y*d+1,d-2,d-2)}},C=function(){var a,d,f,g,j;for(a=0;b>a;a++){for(d=!0,f=0;c>f;f++)if(q[a][f]==e){d=!1;break}if(d){for(k.innerHTML=h+=100,localStorage.setItem("curScore",h),h>=500*i*i&&(l.innerHTML=i+=1,localStorage.setItem("curSpeed",i),clearInterval(n),n=setInterval(w,500/i)),g=a;g>0;g--)for(j=0;c>j;j++)q[g][j]=q[g-1][j];y()}}},window.onkeydown=function(a){switch(a.keyCode){case 40:if(!o)return;w();break;case 37:if(!o)return;z();break;case 39:if(!o)return;A();break;case 38:if(!o)return;B()}},function(a){a=a||"wrapper",console.log("init the game"),console.log(b,c),x(b,c,d,d),document.getElementById(a).appendChild(f),k=document.getElementById("curScoreEle"),l=document.getElementById("curSpeedEle"),m=document.getElementById("maxScoreEle");var e=localStorage.getItem("tetris_status");q=null==e?q:JSON.parse(e),y(),h=localStorage.getItem("curScore"),h=null==h?0:parseInt(h),k.innerHTML=h,j=localStorage.getItem("maxScore"),j=null==j?0:parseInt(j),m.innerHTML=j,i=localStorage.getItem("curSpeed"),i=null==i?1:parseInt(i),l.innerHTML=i,v(),n=setInterval(w,500/i)}}();window.onload=function(){Tetris("wrapper")};