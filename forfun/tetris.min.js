var TETRIS_ROWS=20,TETRIS_COLS=14,CELL_SIZE=24,NO_BLOCK=0,tetris_canvas,tetris_ctx,curScore=0,curSpeed=1,maxScore=0,curScoreEle,curSpeedEle,maxScoreEle,curTimer,isPlaying=!0,currentFall,tetris_status=[];for(var i=0;i<TETRIS_ROWS;i++){tetris_status[i]=[];for(var j=0;j<TETRIS_COLS;j++)tetris_status[i][j]=NO_BLOCK}var colors=["#fff","#f00","#0f0","#00f","#c60","#f0f","#0ff","#609"],blockArr=[[{x:TETRIS_COLS/2-1,y:0,color:1},{x:TETRIS_COLS/2,y:0,color:1},{x:TETRIS_COLS/2,y:1,color:1},{x:TETRIS_COLS/2+1,y:1,color:1}],[{x:TETRIS_COLS/2+1,y:0,color:2},{x:TETRIS_COLS/2,y:0,color:2},{x:TETRIS_COLS/2,y:1,color:2},{x:TETRIS_COLS/2-1,y:1,color:2}],[{x:TETRIS_COLS/2-1,y:0,color:3},{x:TETRIS_COLS/2,y:0,color:3},{x:TETRIS_COLS/2-1,y:1,color:3},{x:TETRIS_COLS/2,y:1,color:3}],[{x:TETRIS_COLS/2-1,y:0,color:4},{x:TETRIS_COLS/2-1,y:1,color:4},{x:TETRIS_COLS/2-1,y:2,color:4},{x:TETRIS_COLS/2,y:2,color:4}],[{x:TETRIS_COLS/2,y:0,color:5},{x:TETRIS_COLS/2,y:1,color:5},{x:TETRIS_COLS/2,y:2,color:5},{x:TETRIS_COLS/2-1,y:2,color:5}],[{x:TETRIS_COLS/2,y:0,color:6},{x:TETRIS_COLS/2,y:1,color:6},{x:TETRIS_COLS/2,y:2,color:6},{x:TETRIS_COLS/2,y:3,color:6}],[{x:TETRIS_COLS/2,y:0,color:7},{x:TETRIS_COLS/2-1,y:1,color:7},{x:TETRIS_COLS/2,y:1,color:7},{x:TETRIS_COLS/2+1,y:1,color:7}]],initBlock=function(){var e=Math.floor(Math.random()*blockArr.length);currentFall=[{x:blockArr[e][0].x,y:blockArr[e][0].y,color:blockArr[e][0].color},{x:blockArr[e][1].x,y:blockArr[e][1].y,color:blockArr[e][1].color},{x:blockArr[e][2].x,y:blockArr[e][2].y,color:blockArr[e][2].color},{x:blockArr[e][3].x,y:blockArr[e][3].y,color:blockArr[e][3].color}]},createCanvas=function(e,t,n,r){tetris_canvas=document.createElement("canvas"),tetris_canvas.width=t*n,tetris_canvas.height=e*r,tetris_canvas.style.border="1px solid black",tetris_ctx=tetris_canvas.getContext("2d"),tetris_ctx.beginPath();for(var i=1;i<TETRIS_ROWS;i++)tetris_ctx.moveTo(0,i*CELL_SIZE),tetris_ctx.lineTo(TETRIS_COLS*CELL_SIZE,i*CELL_SIZE);for(var i=1;i<TETRIS_COLS+1;i++)tetris_ctx.moveTo(i*CELL_SIZE,0),tetris_ctx.lineTo(i*CELL_SIZE,TETRIS_ROWS*CELL_SIZE);tetris_ctx.closePath(),tetris_ctx.strokeStyle="#aaa",tetris_ctx.lineWidth=.3,tetris_ctx.stroke()},drawBlock=function(){for(var e=0;e<TETRIS_ROWS;e++)for(var t=0;t<TETRIS_COLS;t++)tetris_status[e][t]!=NO_BLOCK?(tetris_ctx.fillStyle=colors[tetris_status[e][t]],tetris_ctx.fillRect(t*CELL_SIZE+1,e*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)):(tetris_ctx.fillStyle="white",tetris_ctx.fillRect(t*CELL_SIZE+1,e*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2))};window.onload=function(){createCanvas(TETRIS_ROWS,TETRIS_COLS,CELL_SIZE,CELL_SIZE),document.getElementById("wrapper").appendChild(tetris_canvas),curScoreEle=document.getElementById("curScoreEle"),curSpeedEle=document.getElementById("curSpeedEle"),maxScoreEle=document.getElementById("maxScoreEle");var e=localStorage.getItem("tetris_status");tetris_status=e==null?tetris_status:JSON.parse(e),drawBlock(),curScore=localStorage.getItem("curScore"),curScore=curScore==null?0:parseInt(curScore),curScoreEle.innerHTML=curScore,maxScore=localStorage.getItem("maxScore"),maxScore=maxScore==null?0:parseInt(maxScore),maxScoreEle.innerHTML=maxScore,curSpeed=localStorage.getItem("curSpeed"),curSpeed=curSpeed==null?1:parseInt(curSpeed),curSpeedEle.innerHTML=curSpeed,initBlock(),curTimer=setInterval("moveDown();",500/curSpeed)};var lineFull=function(){for(var e=0;e<TETRIS_ROWS;e++){var t=!0;for(var n=0;n<TETRIS_COLS;n++)if(tetris_status[e][n]==NO_BLOCK){t=!1;break}if(t){curScoreEle.innerHTML=curScore+=100,localStorage.setItem("curScore",curScore),curScore>=curSpeed*curSpeed*500&&(curSpeedEle.innerHTML=curSpeed+=1,localStorage.setItem("curSpeed",curSpeed),clearInterval(curTimer),curTimer=setInterval("moveDown();",500/curSpeed));for(var r=e;r>0;r--)for(var i=0;i<TETRIS_COLS;i++)tetris_status[r][i]=tetris_status[r-1][i];drawBlock()}}},moveDown=function(){var e=!0;for(var t=0;t<currentFall.length;t++){if(currentFall[t].y>=TETRIS_ROWS-1){e=!1;break}if(tetris_status[currentFall[t].y+1][currentFall[t].x]!=NO_BLOCK){e=!1;break}}if(e){for(var t=0;t<currentFall.length;t++){var n=currentFall[t];tetris_ctx.fillStyle="white",tetris_ctx.fillRect(n.x*CELL_SIZE+1,n.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}for(var t=0;t<currentFall.length;t++){var n=currentFall[t];n.y++}for(var t=0;t<currentFall.length;t++){var n=currentFall[t];tetris_ctx.fillStyle=colors[n.color],tetris_ctx.fillRect(n.x*CELL_SIZE+1,n.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}}else{for(var t=0;t<currentFall.length;t++){var n=currentFall[t];if(n.y<2){localStorage.removeItem("curScore"),localStorage.removeItem("tetris_status"),localStorage.removeItem("curSpeed"),confirm("您已经输了！是否参数排名？")&&(maxScore=localStorage.getItem("maxScore"),maxScore=maxScore==null?0:maxScore,curScore>=maxScore&&localStorage.setItem("maxScore",curScore)),isPlaying=!1,clearInterval(curTimer);return}tetris_status[n.y][n.x]=n.color}lineFull(),localStorage.setItem("tetris_status",JSON.stringify(tetris_status)),initBlock()}},moveLeft=function(){var e=!0;for(var t=0;t<currentFall.length;t++){if(currentFall[t].x<=0){e=!1;break}if(tetris_status[currentFall[t].y][currentFall[t].x-1]!=NO_BLOCK){e=!1;break}}if(e){for(var t=0;t<currentFall.length;t++){var n=currentFall[t];tetris_ctx.fillStyle="white",tetris_ctx.fillRect(n.x*CELL_SIZE+1,n.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}for(var t=0;t<currentFall.length;t++){var n=currentFall[t];n.x--}for(var t=0;t<currentFall.length;t++){var n=currentFall[t];tetris_ctx.fillStyle=colors[n.color],tetris_ctx.fillRect(n.x*CELL_SIZE+1,n.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}}},moveRight=function(){var e=!0;for(var t=0;t<currentFall.length;t++){if(currentFall[t].x>=TETRIS_COLS-1){e=!1;break}if(tetris_status[currentFall[t].y][currentFall[t].x+1]!=NO_BLOCK){e=!1;break}}if(e){for(var t=0;t<currentFall.length;t++){var n=currentFall[t];tetris_ctx.fillStyle="white",tetris_ctx.fillRect(n.x*CELL_SIZE+1,n.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}for(var t=0;t<currentFall.length;t++){var n=currentFall[t];n.x++}for(var t=0;t<currentFall.length;t++){var n=currentFall[t];tetris_ctx.fillStyle=colors[n.color],tetris_ctx.fillRect(n.x*CELL_SIZE+1,n.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}}},rotate=function(){var e=!0;for(var t=0;t<currentFall.length;t++){var n=currentFall[t].x,r=currentFall[t].y;if(t!=2){var i=currentFall[2].x+r-currentFall[2].y,s=currentFall[2].y+currentFall[2].x-n;if(tetris_status[s][i+1]!=NO_BLOCK){e=!1;break}if(i<0||tetris_status[s-1][i]!=NO_BLOCK){moveRight(),i=currentFall[2].x+r-currentFall[2].y,s=currentFall[2].y+currentFall[2].x-n;break}if(i<0||tetris_status[s-1][i]!=NO_BLOCK){moveRight();break}if(i>=TETRIS_COLS-1||tetris_status[s][i+1]!=NO_BLOCK){moveLeft(),i=currentFall[2].x+r-currentFall[2].y,s=currentFall[2].y+currentFall[2].x-n;break}if(i>=TETRIS_COLS-1||tetris_status[s][i+1]!=NO_BLOCK){moveLeft();break}}}if(e){for(var t=0;t<currentFall.length;t++){var o=currentFall[t];tetris_ctx.fillStyle="white",tetris_ctx.fillRect(o.x*CELL_SIZE+1,o.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}for(var t=0;t<currentFall.length;t++){var n=currentFall[t].x,r=currentFall[t].y;t!=2&&(currentFall[t].x=currentFall[2].x+r-currentFall[2].y,currentFall[t].y=currentFall[2].y+currentFall[2].x-n)}for(var t=0;t<currentFall.length;t++){var o=currentFall[t];tetris_ctx.fillStyle=colors[o.color],tetris_ctx.fillRect(o.x*CELL_SIZE+1,o.y*CELL_SIZE+1,CELL_SIZE-2,CELL_SIZE-2)}}};window.focus(),window.onkeydown=function(e){switch(e.keyCode){case 40:if(!isPlaying)return;moveDown();break;case 37:if(!isPlaying)return;moveLeft();break;case 39:if(!isPlaying)return;moveRight();break;case 38:if(!isPlaying)return;rotate()}}